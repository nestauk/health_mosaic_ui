<script context="module">
  export async function preload() {

  }
</script>

<script>
  import { page, goto } from '@sapper/app';

  import { quintOut } from 'svelte/easing';
  import { onMount, tick } from 'svelte';

  // import { Results, ResultsItem } from '../../components/Results';
  import SearchWidget from '../../components/SearchWidget.html';
  // import { store, state } from '../../machines/search';

  import anime from 'animejs';

  let search, index = 0, activeImg = [], animation, animation2;
  const images = ['puppy01.jpg', 'puppy02.jpg', 'puppy03.jpg', 'puppy04.jpg', 'puppy05.jpg', 'puppy06.jpg'];
  const states = {
    current: 'open',
    open: 'close',
    close: 'open'
  };


  async function animateSearch() {
    states.current = states[states.current];
    // await tick();

    if (search && states.current === 'close') {
      const { height } = search.getBoundingClientRect();
      search.style.transform = `translateY(-${height - (3.5 * 10) + 1}px)`;
    } else if (search) {
      search.style.transform = 'translateY(0)';
    }
  }
  // $: {

  // }

  page.subscribe(({ path }) => {
    const newIndex = parseInt(path.replace('/search-results/puppy', ''));
    index = isNaN(newIndex) ? 0 : newIndex;
  });

  let done;
  const changeIndex = () => {
    if (index === images.length -1) return;

    window.removeEventListener('wheel', changeIndex);
    //console.log(window);
    //if (!window) return changeImage();
    // console.log(activeImg);
    animation.play();

    animation.finished.then(() => {
      done = true;
      // console.log('wooooooo');
      // goto(`/search-results/puppy${index + 1}`);
      window.addEventListener('wheel', changeIndex);
    });


  };

  onMount(() => {
    window.addEventListener('wheel', changeIndex);
    animation = anime.timeline({
      autoplay: false,
      duration: 500,
      easing: 'easeOutQuint',
    })
      .add({
        targets: activeImg,
        scale: 0.25,
        rotateY: '20deg',
        translateZ: (t, i, l) => i * 40 + 'px ',
        translateX: (t, i, l) => i * 40 + 'px ',
        // translateY: (t, i, l) => i * 20 + 'px ',
        duration: 250
      })
      .add({
        targets: activeImg,
        translateZ: (t, i, l) => i * (50 * (i+1)) + 'px',
        translateX: (t, i, l) => i * (50 * (i+1)) + 'px',
        translateY: (t, i, l) => i * (25 * (i+1)) + 'px',
      });
    // animation = new anime({
    //   autoplay: false,
    //   targets: activeImg,
    //   scale: 0.25,
    //   rotateY: '30deg',
    //   translateZ: (t, i, l) => i * 100 + 'px ',
    //   translateX: (t, i, l) => i * 100 + 'px ',
    //   translateY: (t, i, l) => i * 50 + 'px ',
    //   duration: 500,
    //   easing: 'easeOutQuint',
    //   loop: false,
    // });


  });

  // function snappy(node, {duration = 500, i = 0}) {
  //   Object.assign(node.style, {
  //     zIndex: i === -1 ? 2 : 0
  //   });

  //   return {
  //     duration,
  //     delay: 0,
  //     easing: quintOut,
  //     css: (t, u) => `transform: scale(${1+2*u}); opacity: ${t}; `
  //   }
  // }

  function snappy(node, {duration = 500, i = 0}) {
    Object.assign(node.style, {
      zIndex: i === -1 ? 2 : 0
    });
    return {
      duration,
      delay: 0,
      easing: quintOut,
      tick: () => ``
    };
  }

  function whoosh(i) {
    if (!done) return;
    const l = activeImg.length;

   anime.timeline({
      autoplay: true,
      duration: 500,
      easing: 'easeOutQuint',
    })
      .add({
        targets: activeImg[i],
        // scale: 0.25,
        // rotateY: '0deg',
        // translateZ: (t, i, l) => i * 40 + 'px ',
        translateX: () => (i * (50 * (i+1))) - ((l-i) * (50 * (i+1))) + 'px',
        // translateY: (t, i, l) => i * 20 + 'px ',
        duration: 250
      });

    // anime.timeline({
    //   autoplay: true,
    //   duration: 500,
    //   easing: 'easeOutQuint',
    // })
    //   .add({
    //     targets: activeImg,
    //     // scale: 0.25,
    //     // rotateY: '0deg',
    //     translateZ: (t, index, l) => {
    //       if (index <= i) return index * (50 * (index+1)) + 'px';
    //       if (index > i) return index * (10 * (index+1)) + 200 + 'px';
    //       // return i * 20 + 'px '
    //     },
    //     //translateX: () => (i * (50 * (i+1))) - ((l-i) * (50 * (i+1))) + 'px',
    //     // translateY: (t, i, l) => i * 20 + 'px ',
    //     duration: 250
    //   })
  }

  function whooshBack(i) {
    if (!done) return;
    animation = anime.timeline({
      autoplay: true,
      duration: 500,
      easing: 'easeOutQuint',
    })
      .add({
        targets: activeImg[i],
        // scale: 0.25,
        // rotateY: '0deg',
        // translateZ: (t, i, l) => i * 40 + 'px ',
        translateX: () => i * (50 * (i+1)) + 'px',
        // translateY: (t, i, l) => i * 20 + 'px ',
        duration: 250
      })
  }
</script>

<svelte:head>
  <title>Search with snappy results</title>
</svelte:head>

<div class="search" bind:this="{search}">
    <SearchWidget />
<div class="close-label" on:click="{animateSearch}">
  {states.current === 'close' ? 'OPEN' : 'CLOSE'}
</div>

</div>
<div class="content">
  <!-- {#if $store.data && $store.data.length }
  {/if} -->
  {#each images as img, i (img)}
    <!-- {#if i ===  index } -->
      <img bind:this={activeImg[i]} class="image-{i - index}"
           src="./test-images/puppy0{i+1}.jpg"
           on:mouseenter={() => whoosh(i)}
           on:mouseleave={() => whooshBack(i)}
           alt=""  />
    <!-- {/if} -->
  {/each}
</div>




<style>

  .search {
    position: absolute;
    width: 100%;
    top: 0;
    left: 0;
    box-shadow: 0 1px 5px 1px rgba(0,0,0,0.2);
    padding: 0 3em 3em 3em;
    transition: 0.5s;
    z-index: 3;
    background: #fff;
  }

  .close-label {
    position: absolute;
    bottom: 0;
    text-align: center;
    background: #333;
    color: #eee;
    left: -30px;
    right: -30px;
    width: calc(100% + 30px);
    padding: 5px 0;
    cursor:pointer;
  }

  .content {
    width: 100%;
    height: calc(100vh - 3.5rem);
    position: relative;
    overflow: hidden;
    perspective: 3000px;

  }

  img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 0;
    transform-origin: 20% 20%;
    /* transition: 1s;
    transition-delay: 2s;
    opacity: 0; */
    /* box-shadow:  -10px -10px 85px 33px rgba(0,0,0,0.2) */
  }
  .image-0 {
    /* z-index: 2;
    opacity: 1; */
  }

  .image-1 {
    /* z-index: 1; */
    /* transform: scale(0.8); */
    /* opacity: 0.5; */
  }
</style>
