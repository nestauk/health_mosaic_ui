<script>
  import { onMount, tick, afterUpdate } from 'svelte';
  import debounce from 'just-debounce';

  export let currentTab, currentState, send;
  let container,
    containerHeight,
    containerWidth,
    absEls,
    gridEls,
    absContainer,
    lastState;

  function recalculateGrid(height, width) {
    Object.assign(absContainer.style, {
      transform: `translate(-${width / 3}px, -${height / 3}px)`,
    });
  }

  const refreshStyles = async (animate = false) => {
    gridEls = Array.from(container.children[0].children);
    absEls = Array.from(container.children[1].children);

    const positions = gridEls
      .filter(el => el.tagName === 'DIV')
      .map(v => v.getBoundingClientRect());
    const containerTop = container.getBoundingClientRect().top;

    absEls.forEach(async (node, i) => {
      const { top, left, bottom, right, width, height } = positions[i];
      Object.assign(node.style, {
        transition: animate ? '0.5s' : 0,
        position: 'absolute',
        top: `${top - containerTop}px`,
        left: `${left}px`,
        bottom: `${bottom}px`,
        right: `${right}px`,
        width: `${width}px`,
        height: `${height}px`,
      });
    });

    await tick();
  };

  onMount(async () => {
    gridEls = Array.from(container.children[0].children);
    absEls = Array.from(container.children[1].children);

    async function resize() {
      await tick();
      recalculateGrid(containerHeight, containerWidth);
      await tick();
      refreshStyles();
    }

    await resize();

    window.addEventListener('resize', resize);

    return () => {
      window.removeEventListener(resize);
    };
  });

  function generateClass(state) {
    if (Object.values(state).includes('apply')) return '';
    return Object.values(state);
  }

  $: stateShortname = Object.keys(currentState)[0];
  let stateClass = '';
  afterUpdate(async () => {
    if (lastState === Object.values(currentState)[0]) return;
    lastState = Object.values(currentState)[0];

    if (lastState === 'start' || lastState === 'end') {
      stateClass = generateClass(currentState);
      await tick();
      send('NEXT');
      return;
    }

    if (lastState === 'applystart') {
      await refreshStyles();
      send('NEXT');
      return;
    }

    if (lastState === 'applyend') {
      refreshStyles(true);
      await tick();
      send('NEXT');
    }
    // apply start
  });
</script>

<div class="container" bind:this="{container}">
  <div
    class="fake-grid {stateShortname} {stateClass}"
    bind:this="{absContainer}"
    bind:offsetHeight="{containerHeight}"
    bind:offsetWidth="{containerWidth}"
  >
    {#each currentTab.components as {name}}
    <div class="item {name}"></div>
    {/each}
  </div>

  <div class="abs-container {currentState}">
    {#each currentTab.components as {component, props, id, }}
    <div class="{name}">
      <svelte:component this="{component}" {...props} {id} />
    </div>
    {/each}
  </div>
</div>

<style lang="less">
  .container {
    position: absolute;
    height: 100%;
    width: calc(100% - 196px);
  }

  .fake-grid {
    display: grid;
    width: 300%;
    height: 300%;
    margin-left: 196px;
    grid-gap: 10px;
    grid-template-columns:
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr;
    grid-template-rows:
      1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr;
  }

  @import '../../styles/facets.less';
</style>
