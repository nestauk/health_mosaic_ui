<script context="module">
  export const TRANSITION = {};
</script>

<script>

  import { onMount, tick, afterUpdate, setContext } from 'svelte';
  import Chart from './Chart.html';
  import { get } from 'svelte/store';

  export let currentTab, currentState, send;
  let container,
    containerHeight,
    containerWidth,
    absEls,
    gridEls,
    absContainer,
    lastState,
    transitions = [];

  function recalculateGrid(height, width) {
    Object.assign(absContainer.style, {
      transform: `translate(-${width / 3}px, -${height / 3}px)`,
    });
  }

  const refreshStyles = async (animate = false) => {
    gridEls = Array.from(container.children[0].children);
    absEls = Array.from(container.children[1].children);

    const positions = gridEls
      .filter(el => el.tagName === 'DIV')
      .map(v => v.getBoundingClientRect());
    const containerTop = container.getBoundingClientRect().top;

    absEls.forEach(async (node, i) => {
      Object.assign(node.style, {
        position: 'absolute',
      });
    });
    return positions;
    // await tick();
  };

  setContext(TRANSITION, {
    registerTransition: (id, spring) => {
      const index = transitions.findIndex(t => t.id === id);
      if (index === -1) {
        transitions = transitions.concat(spring);
      } else {
        transitions[index] = spring;
      }
    }
  })

  onMount(async () => {
    gridEls = Array.from(container.children[0].children);
    absEls = Array.from(container.children[1].children);

    async function resize() {
      await tick();
      recalculateGrid(containerHeight, containerWidth);
      await tick();

      const pos = await refreshStyles();
      console.log(pos);
      await Promise.all(
        transitions.map((t, i) => {
          const { top, left, right, bottom, width, height } = pos[i];
          return t.set(
            { top: top-150, left,  width, height },
            { duration: 0 }
          );
        })
      );
      // console.log(springs.map(s => get(s)));
    }

    await resize();

    window.addEventListener('resize', resize);

    return () => {
      window.removeEventListener(resize);
    };
  });

  function generateClass(state) {
    if (Object.values(state).includes('apply')) return '';
    return Object.values(state);
  }

  $: stateShortname = Object.keys(currentState)[0];
  let stateClass = '';
  afterUpdate(async () => {
    if (lastState === Object.values(currentState)[0]) return;
    lastState = Object.values(currentState)[0];

    if (lastState === 'start' || lastState === 'end') {
      stateClass = generateClass(currentState);
      await tick();
      send('NEXT');
      return;
    }

    if (lastState === 'applystart') {
      const pos = await refreshStyles();
      console.log(pos)
      await Promise.all(transitions.map((t, i) => {
          const { top, left, right, bottom, width, height } = pos[i];
          return t.set(
            { top: top-150, left, width, height },
            { duration: 0 }
          );
        }));
      await tick();
      send('NEXT');
      return;
    }

    if (lastState === 'applyend') {
      const pos = await refreshStyles();
      console.log(pos)

      await Promise.all(transitions.map((t, i) => {
          const { top, left, right, bottom, width, height } = pos[i];
          return t.set(
            { top:top-150, left,  width, height },
            { duration: 500 }
          );
        }));
      await tick();
      send('NEXT');
    }
    // apply start
  });

  //$: springarray = currentTab.components.map((s, i) => get(s.transition));
</script>

<div class="container" bind:this="{container}">
  <div
    class="fake-grid {stateShortname} {stateClass}"
    bind:this="{absContainer}"
    bind:offsetHeight="{containerHeight}"
    bind:offsetWidth="{containerWidth}"
  >
    {#each currentTab.components as {name}}
    <div class="item {name}"></div>
    {/each}
  </div>

  <div class="abs-container {currentState}">
    {#each currentTab.components as {component, props, id, name, transition }, i}
      <Chart {component} {props} {id} {name} {transition}/>
    {/each}
  </div>
</div>

<style lang="less">
  .container {
    position: absolute;
    height: 100%;
    width: calc(100% - 196px);
  }

  .fake-grid {
    display: grid;
    width: 300%;
    height: 300%;
    margin-left: 196px;
    grid-gap: 10px;
    grid-template-columns:
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr 1fr 1fr;
    grid-template-rows:
      1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr
      1fr 1fr 1fr 1fr;
  }

  @import './facets.less';
</style>
