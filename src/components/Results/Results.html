<script>
  import { tweened } from 'svelte/motion';

  import {
    resultsMachineConfig,
    resultsMachineOptions,
  } from '../../machines/results.ts';
  import { createTweenStore } from '../../stores/results.ts';
  import { createMachina } from '../../util/xstateHelper.ts';

  import { countByCountry, countByCity } from '../../util/domain';

  import { InstituteMap, Two, Three, Four } from '../Visualisations/';
  import BarChartV from '../BarChartV.html';
  import ResultsGrid from './ResultsGrid.html';

  export let dirty;
  export let results;

  // barcharts data

  $: countryValues = countByCountry(results);
  $: cityValues = countByCity(results);
  $: tabMap = {
    tab1: {
      title: 'Tab One',
      event: 'T1',
      components: [
        {
          component: InstituteMap,
          props: { items: results },
          id: 1,
          name: 'map',
        },
      ],
      tabId: 1,
    },
    tab2: {
      title: 'Tab Two',
      event: 'T2',
      components: [{ component: Two, props: {}, id: 1 }],
      tabId: 4,
    },
    tab3: {
      title: 'Tab Three',
      event: 'T3',
      components: [
        {
          component: BarChartV,
          props: { items: countryValues, title: 'by Country' },
          id: 3,
        },
        {
          component: BarChartV,
          props: { items: cityValues, title: 'by City' },
          id: 2,
        },
      ],
      tabId: 3,
    },
    tab4: {
      title: 'Tab Four',
      event: 'T4',
      components: [{ component: Four, props: {}, id: 1 }],
      id: 1,
      tabId: 4,
    },
    tab5: {
      title: 'Tab Five',
      event: 'T5',
      components: [
        {
          component: InstituteMap,
          name: 'map',
          props: { items: results },
          id: 1,
        },
        {
          component: BarChartV,
          name: 'bar',
          props: { items: cityValues, title: 'by City' },
          id: 2,
        },
      ],
      tabId: 5,
    },
    tab1to5: {
      title: 'Tab One to Five',
      event: 'T1to5',
      components: [
        {
          component: InstituteMap,
          name: 'map',
          props: { items: results },
          id: 1,
        },
        {
          component: BarChartV,
          name: 'bar',
          props: { items: cityValues, title: 'by City' },
          id: 2,
        },
      ],
      tabId: 6,
    },
  };

  $: {
    for (let tab in tabMap) {
      tabMap[tab].components = tabMap[tab].components.map(component => ({
        ...component,
        transition: tweened({
          top: 0,
          left: 0,
          width: 0,
          height: 0,
        }),
      }));
    }

    console.log(tabMap);
  }

  const {
    machine: resultsMachine,
    contextStores: { tweenA, tweenB },
  } = createMachina(resultsMachineConfig, resultsMachineOptions, {
    tweenA: createTweenStore(0, { duration: 1000 }),
    tweenB: createTweenStore(0, { duration: 1000 }),
  });

  const getId = state => tabMap[state.replace(/tab|-.*/, '') - 1].tabId;

  $: currentState = Object.keys($resultsMachine.value.tabs)[0];
  $: currentTab = tabMap[currentState];
</script>

<div class="container" class:dirty="{dirty}">
  <ul>
    {#each Object.entries(tabMap) as [name, {title, event, tabId}]}
    <!--  -->
    {#if !name.includes('to')}
    <li
      class:selected="{currentTab.tabId === tabId}"
      on:click="{() => resultsMachine.send(event)}"
    >
      {title}
    </li>
    {/if}
    <!--  -->
    {/each}
  </ul>

  <ResultsGrid
    tabId="{currentTab.tabId}"
    {currentTab}
    currentState="{$resultsMachine.value.tabs}"
    send="{(event) => resultsMachine.send(event)}"
  >
  </ResultsGrid>
</div>

<style lang="less">
  .container {
    height: calc(100vh - 9.2rem);
    margin-top: 5.6rem;
    overflow: hidden;
    position: relative;

    &.dirty {
      background-color: grey;
      border: 1px solid red;
    }
  }

  .chart-wrap {
    width: 100%;
    height: 100%;
  }

  ul {
    width: 200px;
    height: 100%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ccc;
    position: relative;
    z-index: 1;
    float: left;
  }
  li {
    border-bottom: 1px solid #ccc;
    padding: 20px;
    cursor: pointer;
  }

  li:hover {
    background: #ccc;
  }

  li.selected {
    background: #333;
    color: #eee;
  }
</style>
