<script>
  import { tweened } from 'svelte/motion';

  import {
    resultsMachineConfig,
    resultsMachineOptions,
  } from '../../machines/results.ts';
  import { createTweenStore } from '../../stores/results.ts';
  import { createMachina } from '../../util/xstateHelper.ts';
  import { generateTabMap } from '../../util/charts';

  import { countByCountry, countByCity } from '../../util/domain';

  import ResultsGrid from './ResultsGrid.html';

  export let dirty;
  export let results;

  // barcharts data

  $: countryValues = countByCountry(results);
  $: cityValues = countByCity(results);
  $: tabMap = generateTabMap(results, countryValues, cityValues);

  const {
    machine: resultsMachine,
    contextStores: { tweenA, tweenB },
  } = createMachina(resultsMachineConfig, resultsMachineOptions, {
    tweenA: createTweenStore(0, { duration: 1000 }),
    tweenB: createTweenStore(0, { duration: 1000 }),
  });

  const getId = state => tabMap[state.replace(/tab|-.*/, '') - 1].tabId;

  $: currentState = Object.keys($resultsMachine.value.tabs)[0];
  $: currentTab = tabMap[currentState];
</script>

<div class="container" class:dirty="{dirty}">
  <ul>
    {#each Object.entries(tabMap) as [name, {title, event, tabId}]}
    <!--  -->
    {#if !name.includes('to')}
    <li
      class:selected="{currentTab.tabId === tabId}"
      on:click="{() => resultsMachine.send(event)}"
    >
      {title}
    </li>
    {/if}
    <!--  -->
    {/each}
  </ul>

  <ResultsGrid
    tabId="{currentTab.tabId}"
    {currentTab}
    currentState="{$resultsMachine.value.tabs}"
    send="{(event) => resultsMachine.send(event)}"
  >
  </ResultsGrid>
</div>

<style lang="less">
  .container {
    height: calc(100vh - 9.2rem);
    margin-top: 5.6rem;
    overflow: hidden;
    position: relative;

    &.dirty {
      background-color: grey;
      border: 1px solid red;
    }
  }

  .chart-wrap {
    width: 100%;
    height: 100%;
  }

  ul {
    width: 200px;
    height: 100%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ccc;
    position: relative;
    z-index: 1;
    float: left;
  }
  li {
    border-bottom: 1px solid #ccc;
    padding: 20px;
    cursor: pointer;
  }

  li:hover {
    background: #ccc;
  }

  li.selected {
    background: #333;
    color: #eee;
  }
</style>
