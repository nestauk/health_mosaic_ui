<script>
  import {
    resultsMachineConfig,
    resultsMachineOptions,
  } from '../../machines/results.ts';
  import { createTweenStore } from '../../stores/results.ts';
  import { createMachina } from '../../util/xstateHelper.ts';

  import { countByCountry, countByCity } from '../../util/domain';

  import { One, Two, Three, Four } from '../Visualisations/';
  import BarChartV from '../BarChartV.html';

  export let dirty;
  export let results;

  // barcharts data

  $: countryValues = countByCountry(results);
  $: cityValues = countByCity(results);
  $: tabMap = [
    {
      title: 'Tab One',
      event: 'T1',
      components: [{ component: One, props: { items: results } }],
      tabId: 1,
    },
    {
      title: 'Tab Two',
      event: 'T2',
      components: [{ component: Two, props: {} }],
      tabId: 2,
    },
    {
      title: 'Tab Three',
      event: 'T3',
      components: [
        {
          component: BarChartV,
          props: { items: countryValues, title: 'by Country' },
        },
        {
          component: BarChartV,
          props: { items: cityValues, title: 'by City' },
        },
      ],
      tabId: 3,
    },
    {
      title: 'Tab Four',
      event: 'T4',
      components: [{ component: Four, props: {} }],
      tabId: 4,
    },
  ];

  const {
    machine: resultsMachine,
    contextStores: { tweenA, tweenB },
  } = createMachina(resultsMachineConfig, resultsMachineOptions, {
    tweenA: createTweenStore(0, { duration: 1000 }),
    tweenB: createTweenStore(0, { duration: 1000 }),
  });

  const getId = state => tabMap[state.replace(/tab|-.*/, '') - 1].tabId;

  $: currentState = Object.keys($resultsMachine.value.tabs)[0];
  $: currentTab = tabMap.find(({ tabId }) => getId(currentState) === tabId);
</script>

<div class:dirty="{dirty}">
  <ul>
    {#each tabMap as {title, event, tabId}}
    <li
      class:selected="{currentTab.tabId === tabId}"
      on:click="{() => resultsMachine.send(event)}"
    >
      {title}
    </li>
    {/each}
  </ul>

  {#each currentTab.components as {component, props}}
  <svelte:component
    this="{component}"
    {...props}
    txValue="{$tweenA}"
    tx2Value="{$tweenB}"
  />
  {/each}
</div>

<style lang="less">
  div {
    height: calc(100vh - 9.2rem);
    margin-top: 5.6rem;
    display: flex;

    &.dirty {
      background-color: grey;
      border: 1px solid red;
    }
  }
  ul {
    width: 200px;
    height: 100%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ccc;
  }
  li {
    border-bottom: 1px solid #ccc;
    padding: 20px;
    cursor: pointer;
  }

  li:hover {
    background: #ccc;
  }

  li.selected {
    background: #333;
    color: #eee;
  }
</style>
